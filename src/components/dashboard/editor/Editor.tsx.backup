"use client";

import { useEditor, EditorContent } from '@tiptap/react';
import StarterKit from '@tiptap/starter-kit';
import Image from '@tiptap/extension-image';
import { useState } from 'react';
import { toast } from 'sonner';
import { createArticle } from '@/lib/actions-article';
import Toolbar from './Toolbar';
import Sidebar from './Sidebar';
import { NewsType } from './types';


const extensions = [
  StarterKit.configure({
    heading: {
      levels: [1, 2],
    },
  }),
  Image,
];

import { Eye, Edit3, Columns, Monitor } from 'lucide-react'; // Icons for view switcher
import ArticlePreview from './ArticlePreview';

export default function Editor() {
  const [title, setTitle] = useState('');
  const [category, setCategory] = useState('');
  const [isPublishing, setIsPublishing] = useState(false);
  const [viewMode, setViewMode] = useState<'write' | 'preview' | 'split'>('write');
  
  // Phase 1: Core Metadata State
  const [subHeadline, setSubHeadline] = useState('');
  const [newsType, setNewsType] = useState<NewsType>('regular');
  const [location, setLocation] = useState('');
  const [tags, setTags] = useState<string[]>([]);
  const [keywords, setKeywords] = useState<string[]>([]);

  const tiptapEditor = useEditor({
    extensions,
    content: `
      <h2>শিরোনাম এখানে লিখুন...</h2>
      <p>আপনার খবরটি এখানে লিখতে শুরু করুন। টেক্সট সিলেক্ট করলে ফরম্যাটিং অপশন দেখতে পাবেন।</p>
    `,
    editorProps: {
      attributes: {
        class: 'prose prose-lg max-w-none focus:outline-none min-h-[500px] px-4 py-8 leading-relaxed',
      },
    },
    immediatelyRender: false,
  });

  const handlePublish = async (metadata: any) => {
    if (!tiptapEditor || !title) {
        toast.error('শিরোনাম লিখুন');
        return;
    }

    setIsPublishing(true);
    const content = tiptapEditor.getHTML();
    // Simple slug generator
    const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)+/g, '');

    const formData = new FormData();
    formData.append('title', title);
    formData.append('slug', slug);
    formData.append('content', content);
    formData.append('status', metadata.status);
    formData.append('category', category || 'General');
    // formData.append('image', metadata.image); // TODO: Add Image
    
    // Phase 1: Core Metadata
    formData.append('sub_headline', subHeadline);
    formData.append('news_type', newsType);
    formData.append('location', location);
    formData.append('tags', JSON.stringify(tags));
    formData.append('keywords', JSON.stringify(keywords));

    try {
        await createArticle(formData);
        toast.success('আর্টিকেল প্রকাশিত হয়েছে!');
    } catch (error) {
        toast.error('প্রকাশ করা যায়নি');
    } finally {
        setIsPublishing(false);
    }
  };


  return (
    <div className="flex flex-col bg-white h-full rounded-xl border border-gray-200 overflow-hidden">
       {/* Top View Bar (Above Toolbar) */}
       <div className="border-b border-gray-200 px-4 py-2 flex items-center justify-between bg-gray-50/50">
           <div className="flex items-center gap-1 bg-gray-200 rounded-lg p-1">
               <button 
                 onClick={() => setViewMode('write')}
                 className={`p-1.5 rounded-md transition ${viewMode === 'write' ? 'bg-white shadow-sm text-black' : 'text-gray-500 hover:text-black'}`}
                 title="Write Mode"
               >
                   <Edit3 size={16} />
               </button>
               <button 
                 onClick={() => setViewMode('split')}
                 className={`p-1.5 rounded-md transition ${viewMode === 'split' ? 'bg-white shadow-sm text-black' : 'text-gray-500 hover:text-black'}`}
                 title="Split View"
               >
                   <Columns size={16} />
               </button>
               <button 
                 onClick={() => setViewMode('preview')}
                 className={`p-1.5 rounded-md transition ${viewMode === 'preview' ? 'bg-white shadow-sm text-black' : 'text-gray-500 hover:text-black'}`}
                 title="Preview Mode"
               >
                   <Eye size={16} />
               </button>
           </div>
           
           <div className="text-xs text-gray-500 font-medium flex items-center gap-2">
               <Monitor size={12} />
               <span>Live Preview Active</span>
           </div>
       </div>

       <div className="flex flex-1 overflow-hidden">
           {/* EDITOR PANE */}
           {(viewMode === 'write' || viewMode === 'split') && (
               <div className="flex-1 flex flex-col min-w-0 border-r border-gray-200">
                   <Toolbar editor={tiptapEditor} />
                   
                   <div className="flex-1 overflow-y-auto bg-white article-scroll">
                       <div className="max-w-3xl mx-auto py-8 px-8">
                           {/* Title Input */}
                           <input 
                              type="text" 
                              placeholder="শিরোনাম লিখুন..."
                              value={title}
                              onChange={(e) => setTitle(e.target.value)}
                              className="w-full text-4xl font-bold text-gray-900 placeholder-gray-300 outline-none mb-8 font-serif leading-tight"
                           />
                           
                           <EditorContent editor={tiptapEditor} />
                       </div>
                   </div>
               </div>
           )}

           {/* PREVIEW PANE */}
           {(viewMode === 'preview' || viewMode === 'split') && (
               <div className={`flex-1 bg-gray-100 overflow-y-auto border-r border-gray-200 ${viewMode === 'split' ? 'hidden lg:block' : ''}`}>
                   <div className="max-w-[100%] mx-auto min-h-full">
                       <div className="bg-white min-h-full shadow-sm p-4 md:p-8 transform origin-top scale-[0.9] md:scale-100 transition-transform">
                          <div className="pointer-events-none select-none"> {/* Prevent interaction in preview */}
                             <ArticlePreview 
                                title={title}
                                content={tiptapEditor?.getHTML() || ''}
                                category={category}
                             />
                          </div>
                       </div>
                   </div>
               </div>
           )}

           {/* SIDEBAR (Always right) */}
           <Sidebar 
                onPublish={handlePublish} 
                isPublishing={isPublishing} 
                category={category}
                setCategory={setCategory}
           />
       </div>
    </div>
  );
}
